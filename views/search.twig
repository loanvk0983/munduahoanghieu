{% extends "layout.twig" %}

{% block title %}{% if keyword %}T√¨m ki·∫øm: {{ keyword }}{% else %}T√¨m ki·∫øm{% endif %} - M·ª•n D·ª´a Ho√†ng Hi·∫øu{% endblock %}

{% block meta %}
<meta name="description" content="{% if keyword %}K·∫øt qu·∫£ t√¨m ki·∫øm cho '{{ keyword }}' tr√™n website M·ª•n D·ª´a Ho√†ng Hi·∫øu{% else %}T√¨m ki·∫øm s·∫£n ph·∫©m v√† b√†i vi·∫øt{% endif %}">
<meta name="keywords" content="t√¨m ki·∫øm, m·ª•n d·ª´a, {{ keyword }}, s·∫£n ph·∫©m n√¥ng nghi·ªáp">
{% endblock %}

{% block head %}
<link rel="stylesheet" href="/css/search.css">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-green-50 to-white py-8">
  <div class="container mx-auto px-4 max-w-6xl">
    
    {# Search Header #}
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-green-800 mb-4 flex items-center gap-3">
        <span class="text-4xl">üîç</span>
        K·∫øt Qu·∫£ T√¨m Ki·∫øm
      </h1>
      
      {# Search Box #}
      <form action="/search" method="GET" class="mb-6">
        <div class="flex gap-2">
          <input
            type="text"
            name="q"
            value="{{ keyword }}"
            placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..."
            class="flex-1 px-4 py-3 border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-lg"
            minlength="2"
            autofocus
          />
          <button
            type="submit"
            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold whitespace-nowrap"
          >
            üîç T√¨m
          </button>
        </div>
      </form>

      {% if keyword %}
        <p class="text-gray-600 text-lg">
          T√¨m ki·∫øm cho: <span class="font-bold text-green-700">"{{ keyword }}"</span>
          {% if results | length > 0 %}
            - <span class="text-green-600 font-semibold">{{ results | length }} k·∫øt qu·∫£</span>
          {% endif %}
        </p>
      {% endif %}
    </div>

    {# Error Message #}
    {% if error %}
      <div class="mb-6">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
          <p class="text-red-700 flex items-center gap-2">
            <span class="text-xl">‚ö†Ô∏è</span>
            {{ error }}
          </p>
        </div>
      </div>
    {% endif %}

    {# Results #}
    {% if results | length > 0 %}
      
      {# Category Tabs - CH·ªà hi·ªÉn th·ªã S·∫£n ph·∫©m v√† Trang #}
      <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
        <button 
          class="category-filter-btn active px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all"
          data-category="all"
        >
          üìö T·∫•t c·∫£ ({{ results | length }})
        </button>
        {% if resultsByType.products | length > 0 %}
          <button 
            class="category-filter-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all"
            data-category="product"
          >
            ü•• S·∫£n ph·∫©m ({{ resultsByType.products | length }})
          </button>
        {% endif %}
        {% if resultsByType.pages | length > 0 %}
          <button 
            class="category-filter-btn px-4 py-2 rounded-lg font-semibold whitespace-nowrap transition-all"
            data-category="page"
          >
            üìÑ Trang ({{ resultsByType.pages | length }})
          </button>
        {% endif %}
      </div>

      {# Results Grid #}
      <div class="grid gap-6">
        {% for item in results %}
          <div 
            class="result-item bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 p-6 border-l-4 border-green-500"
            data-type="{{ item.type }}"
          >
            <div class="flex flex-col md:flex-row gap-4">
              
              {# Image #}
              {% if item.image or item.thumbnail %}
                <div class="md:w-48 flex-shrink-0">
                  <img
                    src="{{ item.image | default(item.thumbnail) }}"
                    alt="{{ item.title | default(item.name) }}"
                    class="w-full h-48 object-cover rounded-lg"
                    onerror="this.src='/assets/image/placeholder.jpg'"
                    loading="lazy"
                  />
                </div>
              {% endif %}

              {# Content #}
              <div class="flex-1">
                {# Type Badge - CH·ªà product v√† page #}
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full mb-2
                  {% if item.type == 'product' %}bg-green-100 text-green-700
                  {% else %}bg-orange-100 text-orange-700{% endif %}">
                  {% if item.type == 'product' %}ü•• S·∫£n ph·∫©m
                  {% else %}üìÑ Trang{% endif %}
                </span>

                {# Title #}
                <h3 class="text-xl font-bold text-gray-800 mb-2 hover-title">
                  <a 
                    href="{{ item.url }}"
                    class="hover:text-green-600 transition-colors"
                  >
                    <span class="title-text">{{ item.title | default(item.name) }}</span>
                  </a>
                </h3>

                {# Description #}
                {% if item.description or item.excerpt %}
                  <p class="text-gray-600 mb-3 line-clamp-3 description-text">
                    {{ item.description | default(item.excerpt) }}
                  </p>
                {% endif %}

                {# Tags #}
                {% if item.tags %}
                  <div class="flex flex-wrap gap-2 mt-2">
                    {% for tag in item.tags %}
                      <span class="tag-item px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">
                        #{{ tag }}
                      </span>
                    {% endfor %}
                  </div>
                {% endif %}

                {# CTA #}
                <a
                  href="{{ item.url }}"
                  class="inline-block mt-4 text-green-600 hover:text-green-700 font-semibold hover:underline"
                >
                  Xem chi ti·∫øt ‚Üí
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      {# No Results #}
      <div class="text-center py-12">
        <div class="text-6xl mb-4">üîç</div>
        <h2 class="text-2xl font-bold text-gray-700 mb-2">
          Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p
        </h2>
        {% if keyword %}
          <p class="text-gray-600 mb-6">
            Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o cho t·ª´ kh√≥a "<strong>{{ keyword }}</strong>"
          </p>
        {% endif %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-6 max-w-md mx-auto text-left">
          <p class="font-semibold text-green-800 mb-2">üí° G·ª£i √Ω:</p>
          <ul class="text-gray-700 space-y-1 text-sm">
            <li>‚Ä¢ Ki·ªÉm tra l·∫°i ch√≠nh t·∫£</li>
            <li>‚Ä¢ Th·ª≠ t·ª´ kh√≥a kh√°c ho·∫∑c ng·∫Øn g·ªçn h∆°n</li>
            <li>‚Ä¢ S·ª≠ d·ª•ng t·ª´ kh√≥a chung h∆°n (VD: "m·ª•n d·ª´a" thay v√¨ "m·ª•n d·ª´a x·ª≠ l√Ω cao c·∫•p")</li>
          </ul>
        </div>
        
        <div class="mt-8">
          <a
            href="/"
            class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
          >
            ‚Üê V·ªÅ trang ch·ªß
          </a>
        </div>
      </div>
    {% endif %}

  </div>
</div>

{# JavaScript for filtering and highlighting #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const keyword = "{{ searchKeyword | default('') }}";
  
  // Category filter functionality
  const filterButtons = document.querySelectorAll('.category-filter-btn');
  const resultItems = document.querySelectorAll('.result-item');

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const category = this.getAttribute('data-category');
      
      // Update active button
      filterButtons.forEach(b => {
        b.classList.remove('active', 'bg-green-600', 'text-white');
        b.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
      });
      this.classList.add('active', 'bg-green-600', 'text-white');
      this.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');

      // Filter items with animation
      resultItems.forEach(item => {
        if (category === 'all' || item.getAttribute('data-type') === category) {
          item.style.display = 'block';
          setTimeout(() => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          }, 10);
        } else {
          item.style.opacity = '0';
          item.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            item.style.display = 'none';
          }, 300);
        }
      });
    });
  });

  // Set initial active state
  const allBtn = document.querySelector('[data-category="all"]');
  if (allBtn) {
    allBtn.classList.add('bg-green-600', 'text-white');
    allBtn.classList.remove('bg-gray-100', 'text-gray-700');
  }

  // Highlight keyword in results (ONLY in text nodes, NOT in attributes)
  if (keyword && keyword.length > 0) {
    highlightKeyword(keyword);
  }
});

function highlightKeyword(keyword) {
  const keywords = keyword.split(/\s+/).filter(k => k.length > 1);
  
  // Target title, description and tags for highlighting
  const textContainers = document.querySelectorAll('.title-text, .description-text, .tag-item');
  
  textContainers.forEach(container => {
    highlightInElement(container, keywords);
  });
}

function highlightInElement(element, keywords) {
  // Process only text nodes
  const walker = document.createTreeWalker(
    element,
    NodeFilter.SHOW_TEXT,
    null,
    false
  );
  
  const textNodes = [];
  let node;
  while (node = walker.nextNode()) {
    textNodes.push(node);
  }
  
  textNodes.forEach(textNode => {
    let text = textNode.textContent;
    let highlightedText = text;
    
    // First, try to highlight the full search phrase (if it exists)
    const fullPhrase = keywords.join(' ');
    const fullPhraseRegex = new RegExp(`(${escapeRegex(fullPhrase)})`, 'gi');
    highlightedText = highlightedText.replace(fullPhraseRegex, '<mark class="bg-yellow-200 px-1 rounded font-semibold">$1</mark>');
    
    // Then highlight individual keywords (only if not already highlighted)
    keywords.forEach(kw => {
      // Skip if keyword is part of already highlighted text
      if (!highlightedText.includes(`<mark`)) {
        const regex = new RegExp(`(${escapeRegex(kw)})`, 'gi');
        highlightedText = highlightedText.replace(regex, '<mark class="bg-yellow-200 px-1 rounded font-semibold">$1</mark>');
      }
    });
    
    // Only update if highlighting occurred
    if (highlightedText !== text) {
      const span = document.createElement('span');
      span.innerHTML = highlightedText;
      textNode.parentNode.replaceChild(span, textNode);
    }
  });
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</script>
{% endblock %}